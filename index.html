<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>SPY-FILES Terminal Gallery</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
    margin: 0; padding: 0;
    font-family: 'Courier New', Courier, monospace;
    color: #33FF33;
    background: #000000;
  }

  body, html {
    height: 100%;
  }

  header {
    padding: 12px 20px;
    border-bottom: 1px solid #33ff33;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  header img {
    height: 36px;
    width: auto;
  }

  header h1 {
    font-weight: 700;
    font-size: 1.5rem;
  }

  main {
    padding: 20px;
    min-height: calc(100vh - 60px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
  }

  #login-section {
    max-width: 320px;
    width: 100%;
    margin-top: 40px;
  }

  #login-section label,
  #login-section input,
  #login-section button {
    display: block;
    width: 100%;
    margin-bottom: 12px;
    font-size: 1.1rem;
    background: #000;
    border: 1px solid #33ff33;
    color: #33ff33;
    padding: 10px 8px;
  }

  #login-section input {
    outline: none;
  }

  #login-section button {
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  #login-section button:hover {
    background-color: #33ff33;
    color: #000;
  }

  #error-msg {
    color: #ff3333;
    margin-bottom: 16px;
    text-align: center;
  }

  #gallery-section {
    display: none;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 900px;
  }

  #upload-section {
    margin-top: 24px;
    border: 1px solid #33ff33;
    padding: 16px;
    width: 100%;
    box-sizing: border-box;
  }

  #upload-section label {
    display: block;
    margin-bottom: 8px;
  }

  #upload-section input[type="file"] {
    color: #33ff33;
  }

  #upload-section button {
    margin-top: 12px;
    width: 100%;
    padding: 12px;
    background: #000;
    border: 1px solid #33ff33;
    color: #33ff33;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  #upload-section button:hover {
    background-color: #33ff33;
    color: #000;
  }

  #gallery {
    margin-top: 20px;
    width: 100%;
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(140px,1fr));
    gap: 15px;
  }

  .gallery-item {
    background: #111;
    padding: 6px;
    border: 1px solid #33ff33;
    border-radius: 4px;
    word-break: break-word;
  }

  .gallery-item img {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 4px;
    margin-bottom: 8px;
  }

  .gallery-item .uid {
    font-size: 0.9rem;
    text-align: center;
  }

  /* Responsive */
  @media (max-width: 600px) {
    header h1 {
      font-size: 1.2rem;
    }
    #login-section, #upload-section, #gallery-section {
      max-width: 100%;
      padding: 0 10px;
    }
    #gallery {
      grid-template-columns: repeat(auto-fill,minmax(120px,1fr));
      gap: 10px;
    }
  }
</style>
</head>
<body>

<header>
  <img src="https://raw.githubusercontent.com/moullakill/SPY-FILES/main/logo.png" alt="SPY-FILES Logo" />
  <h1>SPY-FILES Terminal Gallery</h1>
</header>

<main>

  <section id="login-section">
    <label for="password">Mot de passe :</label>
    <input type="password" id="password" placeholder="Entrez le mot de passe" autocomplete="off" />
    <button id="login-btn">Se connecter</button>
    <div id="error-msg"></div>
  </section>

  <section id="gallery-section">

    <div id="upload-section">
      <label for="file-upload">Téléverser un fichier :</label>
      <input type="file" id="file-upload" />
      <button id="upload-btn">Téléverser</button>
      <div id="upload-status"></div>
    </div>

    <div id="gallery"></div>
  </section>

</main>

<script>
  const PASSWORD = "coffee007";
  const GITHUB_LOG_URL = "https://raw.githubusercontent.com/moullakill/SPY-FILES/main/machine_log.txt";
  const UPLOAD_TOKEN = "hp_Y4GBkrjmC6dil8bZPDnYV6V2zQBp7B2HCZvs";

  const loginSection = document.getElementById('login-section');
  const gallerySection = document.getElementById('gallery-section');
  const passwordInput = document.getElementById('password');
  const loginBtn = document.getElementById('login-btn');
  const errorMsg = document.getElementById('error-msg');
  const galleryDiv = document.getElementById('gallery');

  const fileInput = document.getElementById('file-upload');
  const uploadBtn = document.getElementById('upload-btn');
  const uploadStatus = document.getElementById('upload-status');

  loginBtn.addEventListener('click', () => {
    errorMsg.textContent = "";
    if(passwordInput.value === PASSWORD) {
      loginSection.style.display = 'none';
      gallerySection.style.display = 'flex';
      loadGallery();
    } else {
      errorMsg.textContent = "Mot de passe incorrect";
    }
  });

  // Gestion du chargement et affichage des images depuis le fichier machine_log.txt
  async function loadGallery() {
    galleryDiv.innerHTML = "<p>Chargement des images...</p>";
    try {
      const response = await fetch(GITHUB_LOG_URL);
      if(!response.ok) throw new Error("Impossible de charger le fichier de log");
      const text = await response.text();
      const lines = text.trim().split('\n');

      galleryDiv.innerHTML = "";

      lines.forEach(line => {
        const parts = line.split(':');
        if(parts.length < 2) return;

        const uid = parts[0].trim();
        // Reconstruire la data base64, car les ":" dans la data peuvent casser la séparation
        const base64Data = parts.slice(1).join(':').trim();

        // Détecter le type d'image à partir du base64
        let mimeType = detectMimeType(base64Data);
        if(!mimeType) mimeType = 'image/png'; // fallback

        const imgSrc = `data:${mimeType};base64,${base64Data}`;

        const div = document.createElement('div');
        div.className = 'gallery-item';

        const img = document.createElement('img');
        img.src = imgSrc;
        img.alt = uid;

        const caption = document.createElement('div');
        caption.className = 'uid';
        caption.textContent = uid;

        div.appendChild(img);
        div.appendChild(caption);

        galleryDiv.appendChild(div);
      });

    } catch(err) {
      galleryDiv.innerHTML = `<p style="color:#f33;">Erreur: ${err.message}</p>`;
    }
  }

  // Détecte le mime type d’une image à partir de sa base64 (jpeg, png, gif, bmp)
  function detectMimeType(base64) {
    if(base64.startsWith('/9j/')) return 'image/jpeg';
    if(base64.startsWith('iVBORw0KGgo')) return 'image/png';
    if(base64.startsWith('R0lGOD')) return 'image/gif';
    if(base64.startsWith('Qk0')) return 'image/bmp';
    return null;
  }

  // Upload d’un fichier vers une API (par ex. https://api.anonfiles.com/upload)
  uploadBtn.addEventListener('click', async () => {
    uploadStatus.textContent = "";
    const file = fileInput.files[0];
    if(!file) {
      uploadStatus.textContent = "Veuillez sélectionner un fichier.";
      uploadStatus.style.color = '#f33';
      return;
    }

    uploadStatus.textContent = "Téléversement en cours...";
    uploadStatus.style.color = '#33ff33';

    try {
      const formData = new FormData();
      formData.append("file", file);

      // Exemple : upload sur anonfiles.com ou autre API supportée, ici un fetch POST avec token (exemple)
      // Si tu as une API différente, adapte l’URL et les headers ci-dessous
      const response = await fetch("https://api.anonfiles.com/upload", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${UPLOAD_TOKEN}`
        },
        body: formData
      });

      if(!response.ok) throw new Error(`Erreur HTTP ${response.status}`);

      const result = await response.json();

      if(result.status) {
        uploadStatus.textContent = `Téléversement réussi: ${result.data.file.url.full}`;
        uploadStatus.style.color = '#33ff33';
        // Optionnel : propose un lien cliquable
        uploadStatus.innerHTML = `Téléversement réussi: <a href="${result.data.file.url.full}" target="_blank" rel="noopener noreferrer" style="color:#33ff33;">${result.data.file.url.full}</a>`;
      } else {
        throw new Error(result.error.message || "Erreur inconnue");
      }
    } catch(err) {
      uploadStatus.textContent = `Erreur: ${err.message}`;
      uploadStatus.style.color = '#f33';
    }
  });
</script>

</body>
</html>
