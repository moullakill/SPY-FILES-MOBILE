<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Spy Files - Gallery Terminal</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: "Courier New", Courier, monospace;
    background: #0b0c0d;
    color: #33ff33;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  header {
    background: #002200;
    display: flex;
    align-items: center;
    padding: 10px 20px;
    gap: 10px;
  }
  header img {
    height: 40px;
    width: auto;
  }
  header h1 {
    margin: 0;
    font-weight: normal;
    font-size: 1.5rem;
  }

  main {
    flex: 1;
    padding: 15px;
    max-width: 900px;
    margin: auto;
    width: 100%;
  }

  /* Password form */
  #passwordSection {
    max-width: 400px;
    margin: 40px auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  #passwordSection input[type="password"] {
    padding: 10px;
    font-size: 1.1rem;
    background: #001100;
    border: 2px solid #33ff33;
    color: #33ff33;
    outline-offset: 2px;
  }
  #passwordSection button {
    padding: 10px;
    font-size: 1.1rem;
    background: #004400;
    border: none;
    color: #33ff33;
    cursor: pointer;
    transition: background 0.3s;
  }
  #passwordSection button:hover {
    background: #008800;
  }
  #passwordError {
    color: #ff4444;
    font-weight: bold;
  }

  /* Gallery */
  #gallery {
    display: none;
    margin-top: 10px;
    gap: 10px;
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(120px,1fr));
    justify-items: center;
  }
  #gallery img {
    max-width: 100%;
    border: 2px solid #33ff33;
    cursor: pointer;
    border-radius: 4px;
    transition: transform 0.2s ease;
  }
  #gallery img:hover {
    transform: scale(1.05);
  }

  /* Fullscreen overlay */
  #fullscreenOverlay {
    display: none;
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.95);
    justify-content: center;
    align-items: center;
    z-index: 1000;
    flex-direction: column;
  }
  #fullscreenOverlay img {
    max-width: 90vw;
    max-height: 80vh;
    object-fit: contain;
    cursor: grab;
  }
  #closeBtn {
    position: absolute;
    top: 20px;
    right: 25px;
    font-size: 2rem;
    color: #33ff33;
    cursor: pointer;
    user-select: none;
  }

  /* Upload */
  #uploadSection {
    margin-top: 30px;
    max-width: 400px;
  }
  #uploadSection label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
  }
  #uploadSection input[type="file"] {
    width: 100%;
    background: #001100;
    border: 2px solid #33ff33;
    padding: 6px;
    color: #33ff33;
    cursor: pointer;
  }
  #uploadSection button {
    margin-top: 10px;
    padding: 10px;
    font-size: 1rem;
    background: #004400;
    border: none;
    color: #33ff33;
    cursor: pointer;
    width: 100%;
    transition: background 0.3s;
  }
  #uploadSection button:hover {
    background: #008800;
  }

  /* Responsive tweaks */
  @media (max-width: 480px) {
    header h1 {
      font-size: 1.2rem;
    }
    #passwordSection, #uploadSection {
      max-width: 90vw;
      margin: 20px auto;
    }
    #gallery {
      grid-template-columns: repeat(auto-fill,minmax(90px,1fr));
    }
  }
</style>
</head>
<body>

<header>
  <img src="https://raw.githubusercontent.com/moullakill/SPY-FILES/main/logo.png" alt="Spy Files Logo" />
  <h1>Spy Files - Terminal Gallery</h1>
</header>

<main>
  <section id="passwordSection">
    <input type="password" id="passwordInput" placeholder="Entrez le mot de passe" autocomplete="off" />
    <button id="passwordBtn">Valider</button>
    <div id="passwordError"></div>
  </section>

  <section id="gallery"></section>

  <section id="uploadSection" style="display:none;">
    <label for="fileInput">Téléverser un fichier image :</label>
    <input type="file" id="fileInput" accept="image/*" />
    <button id="uploadBtn">Téléverser</button>
    <div id="uploadStatus"></div>
  </section>
</main>

<!-- Fullscreen overlay -->
<div id="fullscreenOverlay">
  <div id="closeBtn">&times;</div>
  <img id="fullImage" src="" alt="Image plein écran" />
</div>

<script>
  const PASSWORD = "coffee007";
  const PASSWORD_SECTION = document.getElementById("passwordSection");
  const PASSWORD_INPUT = document.getElementById("passwordInput");
  const PASSWORD_BTN = document.getElementById("passwordBtn");
  const PASSWORD_ERROR = document.getElementById("passwordError");

  const GALLERY = document.getElementById("gallery");
  const UPLOAD_SECTION = document.getElementById("uploadSection");
  const FILE_INPUT = document.getElementById("fileInput");
  const UPLOAD_BTN = document.getElementById("uploadBtn");
  const UPLOAD_STATUS = document.getElementById("uploadStatus");

  const FULLSCREEN_OVERLAY = document.getElementById("fullscreenOverlay");
  const FULL_IMAGE = document.getElementById("fullImage");
  const CLOSE_BTN = document.getElementById("closeBtn");

  const GITHUB_LOG_URL = "https://github.com/moullakill/SPY-FILES/raw/main/machine_log.txt";
  const CORS_PROXY = "https://corsproxy.io/?";

  const UPLOAD_TOKEN = "hp_Y4GBkrjmC6dil8bZPDnYV6V2zQBp7B2HCZvs";
  const UPLOAD_API_URL = "https://api.web3.storage/upload";

  // --- Password check ---
  PASSWORD_BTN.onclick = () => {
    const val = PASSWORD_INPUT.value.trim();
    if(val === PASSWORD) {
      PASSWORD_ERROR.textContent = "";
      PASSWORD_SECTION.style.display = "none";
      GALLERY.style.display = "grid";
      UPLOAD_SECTION.style.display = "block";
      loadGallery();
    } else {
      PASSWORD_ERROR.textContent = "Mot de passe incorrect";
    }
  };

  // --- Load gallery ---
  async function loadGallery() {
    GALLERY.innerHTML = "<p>Chargement des images...</p>";
    try {
      const response = await fetch(CORS_PROXY + encodeURIComponent(GITHUB_LOG_URL));
      if (!response.ok) throw new Error("Impossible de charger le fichier de log");
      const text = await response.text();

      // Parse lines, skip empty or invalid
      const lines = text.split("\n").filter(line => line.includes(":"));

      const imgs = [];

      for (const line of lines) {
        const [uid, data] = line.split(":", 2);
        // data format example : "data:image/png;base64,iVBORw0KGgoAAAANS..."
        // on vérifie que data commence par data:image/ et decode image
        if(data.startsWith("data:image/")) {
          imgs.push(data);
        }
      }

      if(imgs.length === 0) {
        GALLERY.innerHTML = "<p>Aucune image disponible.</p>";
        return;
      }

      // Affiche images
      GALLERY.innerHTML = "";
      imgs.forEach(src => {
        const img = document.createElement("img");
        img.src = src;
        img.alt = "Spy File Image";
        img.loading = "lazy";
        img.onclick = () => openFullscreen(src);
        GALLERY.appendChild(img);
      });

    } catch(err) {
      GALLERY.innerHTML = `<p style="color:#f33;">Erreur: ${err.message}</p>`;
    }
  }

  // --- Fullscreen image ---
  function openFullscreen(src) {
    FULL_IMAGE.src = src;
    FULLSCREEN_OVERLAY.style.display = "flex";
    FULL_IMAGE.style.transform = "scale(1)";
    currentScale = 1;
  }
  CLOSE_BTN.onclick = () => {
    FULLSCREEN_OVERLAY.style.display = "none";
    FULL_IMAGE.src = "";
  };

  // Zoom with mousewheel on fullscreen image
  let currentScale = 1;
  FULL_IMAGE.addEventListener("wheel", e => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.1 : 0.1;
    currentScale = Math.min(Math.max(0.5, currentScale + delta), 3);
    FULL_IMAGE.style.transform = `scale(${currentScale})`;
  });

  // --- Upload ---
  UPLOAD_BTN.onclick = async () => {
    if (!FILE_INPUT.files.length) {
      UPLOAD_STATUS.textContent = "Veuillez choisir un fichier.";
      UPLOAD_STATUS.style.color = "#f33";
      return;
    }
    const file = FILE_INPUT.files[0];
    UPLOAD_STATUS.textContent = "Téléversement en cours...";
    UPLOAD_STATUS.style.color = "#33ff33";

    try {
      const res = await fetch(UPLOAD_API_URL, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${UPLOAD_TOKEN}`
        },
        body: file
      });
      if (!res.ok) throw new Error(`Erreur HTTP ${res.status}`);
      const data = await res.json();
      UPLOAD_STATUS.textContent = `Téléversement réussi! CID: ${data.cid}`;
      FILE_INPUT.value = "";
    } catch (err) {
      UPLOAD_STATUS.textContent = "Erreur lors du téléversement: " + err.message;
      UPLOAD_STATUS.style.color = "#f33";
    }
  };
</script>

</body>
</html>
